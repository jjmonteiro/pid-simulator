<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PID Controller Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .output {
            font-size: 18px;
            margin: 10px 0;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin-top: 20px;
        }

        .output span {
            font-weight: bold;
        }

        .controls {
            margin-top: 20px;
        }

        .controls input {
            padding: 5px;
            margin: 5px;
            width: 60px;
            text-align: center;
        }

        .controls button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        .controls button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PID Controller Simulation</h1>

        <div class="output">
            <p><span>Setpoint:</span> <span id="setpoint">0.00</span></p>
            <p><span>Measured Value:</span> <span id="measuredValue">0.00</span></p>
            <p><span>Control Output:</span> <span id="controlOutput">0.00</span></p>
        </div>

        <div class="controls">
            <div>
                <label for="kp">Kp:</label>
                <input type="number" id="kp" value="1.0" step="0.01">
            </div>
            <div>
                <label for="ki">Ki:</label>
                <input type="number" id="ki" value="0.1" step="0.01">
            </div>
            <div>
                <label for="kd">Kd:</label>
                <input type="number" id="kd" value="0.01" step="0.01">
            </div>
            <button id="resetButton">Reset Simulation</button>
        </div>
    </div>

    <script>
        // PID Controller class
        class PID {
            constructor(Kp, Ki, Kd) {
                this.Kp = Kp;
                this.Ki = Ki;
                this.Kd = Kd;
                this.prevError = 0.0;
                this.integral = 0.0;
            }

            // Calculate the PID output
            calculate(setpoint, measuredValue, dt) {
                const error = setpoint - measuredValue;
                const Pout = this.Kp * error; // Proportional term
                this.integral += error * dt;
                const Iout = this.Ki * this.integral; // Integral term
                const derivative = (error - this.prevError) / dt;
                const Dout = this.Kd * derivative; // Derivative term

                const output = Pout + Iout + Dout;
                this.prevError = error;
                return output;
            }
        }

        // Generate a random setpoint within a given range
        function generateRandomSetpoint(min, max) {
            return Math.random() * (max - min) + min;
        }
        
        function formatLargeNumber(number) {
            if (Math.abs(number) > 1e6) {
                return number.toExponential(2); // Display in exponential form with 2 decimal places
            }
            return number.toFixed(2); // Otherwise, show the number with 2 decimal places
        }

        // Update webpage with PID values
        function updateDisplay(setpoint, measuredValue, controlOutput) {
            document.getElementById('setpoint').textContent = formatLargeNumber(setpoint);
            document.getElementById('measuredValue').textContent = formatLargeNumber(measuredValue);
            document.getElementById('controlOutput').textContent = formatLargeNumber(controlOutput);
        }

        let pid; // Declare pid variable for reuse
        let setpoint, measuredValue;
        const dt = 1.0; // Time step in seconds
        const tolerance = 0.5; // Tolerance for reaching setpoint

        // Function to start or reset the simulation
        function startSimulation() {
            const Kp = parseFloat(document.getElementById('kp').value);
            const Ki = parseFloat(document.getElementById('ki').value);
            const Kd = parseFloat(document.getElementById('kd').value);

            pid = new PID(Kp, Ki, Kd);

            measuredValue = 0.0;  // Start value
            setpoint = generateRandomSetpoint(50.0, 150.0); // Initial random setpoint

            // Run PID control loop indefinitely
            setInterval(() => {
                // Calculate PID output
                const controlOutput = pid.calculate(setpoint, measuredValue, dt);

                // Update the measured value based on the control output (simulate process response)
                measuredValue += controlOutput * dt;

                // Update the webpage with the new values
                updateDisplay(setpoint, measuredValue, controlOutput);

                // Check if the measured value is within the tolerance of the setpoint
                if (Math.abs(setpoint - measuredValue) <= tolerance) {
                    // Generate a new random setpoint
                    setpoint = generateRandomSetpoint(50.0, 150.0);
                    pid.prevError = 0.0; // Reset PID state
                    pid.integral = 0.0;
                }
            }, 1000); // Update every second
        }

        // Reset the simulation when the reset button is pressed
        document.getElementById('resetButton').addEventListener('click', startSimulation);

        // Start the simulation when the page loads
        window.onload = startSimulation;
    </script>
</body>
</html>
